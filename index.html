<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Scene Studio</title>
<style>
body { margin:0; font-family:Arial; background:#f5f5f5; display:flex; height:100vh; }
#sidebar { width:30%; background:#fff; border-right:1px solid #ddd; padding:20px; overflow-y:auto; }
#main { width:70%; padding:20px; }
textarea { width:100%; height:80px; margin-top:5px; }
button { margin-top:8px; padding:8px 12px; background:#1a73e8; border:none; color:white; cursor:pointer; }
canvas { margin-top:20px; max-width:100%; border:1px solid #ddd; }
.layer { margin-bottom:15px; }
h2 { margin-top:0; }
</style>
</head>
<body>

<div id="sidebar">
  <h2>Слои</h2>
  <div id="layers"></div>
  <button onclick="decompose()">Разбить сцену</button>
</div>

<div id="main">
  <h2>Описание сцены</h2>
  <textarea id="sceneInput"></textarea>
  <button onclick="generateImage()">Сгенерировать</button>
  <canvas id="canvas"></canvas>
</div>

<script>
let layers = [];

async function decompose() {
  const scene = document.getElementById("sceneInput").value;

  const res = await fetch("/generate_text", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      prompt: `Разбей сцену на JSON со слоями: Background, Character, Lighting, Atmosphere. Сцена: ${scene}`
    })
  });

  const data = await res.json();

  try {
    layers = JSON.parse(data.text);
    renderLayers();
  } catch {
    alert("Ошибка разбора JSON. Уточни сцену.");
  }
}

function renderLayers() {
  const container = document.getElementById("layers");
  container.innerHTML = "";

  layers.forEach((layer, i) => {
    const div = document.createElement("div");
    div.className = "layer";
    div.innerHTML = `
      <strong>${layer.name}</strong>
      <textarea onchange="updateLayer(${i}, this.value)">${layer.prompt}</textarea>
      <button onclick="improveLayer(${i})">Улучшить</button>
    `;
    container.appendChild(div);
  });
}

function updateLayer(i, value) {
  layers[i].prompt = value;
}

async function improveLayer(i) {
  const res = await fetch("/generate_text", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      prompt: `Улучши визуальный промпт: ${layers[i].prompt}`
    })
  });
  const data = await res.json();
  layers[i].prompt = data.text;
  renderLayers();
}

async function generateImage() {
  const fullPrompt = layers.map(l => l.prompt).join(", ");

  const res = await fetch("/generate_image", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ prompt: fullPrompt })
  });

  const data = await res.json();

  if (data.image) {
    const img = new Image();
    img.src = "data:image/png;base64," + data.image;
    img.onload = () => {
      const canvas = document.getElementById("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
    };
  }
}
</script>

</body>
</html>
